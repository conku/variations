"use strict";var _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t};!function(t){"function"==typeof define&&define.amd?define(["jquery"],t):t("object"===("undefined"==typeof exports?"undefined":_typeof(exports))?require("jquery"):jQuery)}(function(t){function i(e,a){this.$element=t(e),this.options=t.extend({},i.DEFAULTS,t.isPlainObject(a)&&a),this.init()}var e=window._,a=t(document),n="qor.product.variants",r="qor.replicator",o="enable."+n,s="disable."+n,l="click."+n,d="keyup."+n,c="changed.medialibrary",h="added."+r,u='.qor-product__property select[data-toggle="qor.chooser"]',p=".qor-product__property-selector",f=".qor-product__table tbody",v=".qor-product__container",m=".qor-fieldset",y=".qor-fieldset__add",g="qor_variants_id_",b="should_remove",_=".qor-fieldset--init",q=".qor-fieldset:not(.qor-fieldset--new)",D='input[name*="QorResource.Variations"]:visible',V=".qor-field__mediabox-data",M=".qor-product__button-save";return i.prototype={constructor:i,init:function(){var t=this.$element;this.bind(),this.variants={},this.PrimaryInitMetaData={},this.productMetas=[],this.templateData=[],this.primaryMeta=[],this.$tbody=t.find(f),this.$replicatorBtn=t.find(y),this.initMetas(),this.initPrimaryMeta()},bind:function(){a.on(h,this.addVariantReplicator.bind(this)),this.$element.on("select2:select select2:unselect",u,this.selectVariants.bind(this)).on(l,".qor-product__action--edit",this.editVariant.bind(this))},unbind:function(){},initMetas:function(){for(var i=this.$element.find(".qor-product__meta"),e=0,a=i.length;e<a;e++)this.productMetas.push(t(i[e]).data("inputName"));this.setTemplate()},initPrimaryMeta:function(){for(var i=this.$element.find(p),a=this.$element.find(_),n={},r={},o=0,s=i.length;o<s;o++){var l=[],d=t(i[o]).data("variant-type");this.primaryMeta.push(d);for(var c=0,h=a.length;c<h;c++){var u=t(a[c]),f=u.find("[name$="+d+"]").not('[type="hidden"]'),v={};f.is("select")&&f.val()&&(v[d]=f.find("option").text(),v.id=f.val(),e.isEqual(r,v)||l.push(v)),r=v}l.length&&(n[d+"s"]=l)}this.PrimaryInitMetaData=n,this.initPrimarySelector()},initPrimarySelector:function(){var i=this.PrimaryInitMetaData,e=Object.keys(i);this.ingoreInitChange=!0;for(var a=0,n=e.length;a<n;a++){for(var r=e[a].slice(0,-1),o=t('[data-variant-type="'+r+'"]').find(".qor-field__input-selector"),s=i[e[a]],l=0,d=s.length;l<d;l++)o.append("<option selected value='"+s[l].id+"'>"+s[l][r]+"</option>");o.trigger("change")}this.ingoreInitChange=!1},removeSpace:function(t){return t.toString().replace(/\s/g,"")},setTemplate:function(){var t=this.productMetas,i="<tr variants-id=[[variantID]]>",a='<td>\n                                <button type="button" id="qor-product-actions-for-[[index]]" class="mdl-button mdl-js-button mdl-button--icon qor-product__action">\n                                    <i class="material-icons">more_vert</i>\n                                </button>\n                                <ul class="mdl-menu mdl-menu--bottom-right mdl-js-menu" for="qor-product-actions-for-[[index]]">\n                                    <li class="mdl-menu__item" qor-icon-name="Edit">\n                                        <a href="javascript://" class="qor-product__action--edit">Edit</a>\n                                    </li>\n                                </ul>\n                            </td></tr>';e.each(t,function(t){i=i+"<td data-variant-type="+t+">[["+t+"]]</td>"}),this.template=""+i+a},editVariant:function(i){var e=t(i.target).closest("tr"),a=e.find("td").length,n=e.attr("variants-id"),r=e.find("td:first").data("inputName"),o=void 0,s=t('<tr class="qor-variant__edit"><td class="normal" colspan='+a+"></td></tr>");if(r)o=t('[name="'+r+'"]').not('[type="hidden"]').closest(m);else{if(!n)return!1;o=t("#"+n)}e.after(s),o.appendTo(s.find("td")).find(M).remove().end().append('<button type="button" class="mdl-button mdl-js-button mdl-button--raised '+M.replace(".","")+'">OK</button>').show().removeClass("hidden").on(d,D,this.syncCollectionToVariant.bind(this)).on(l,M,this.saveCollevtionEdit.bind(this)).on(c,V,this.syncCollectionToVariant.bind(this)),this.$editableVariant=e,this.$editableCollection=o,this.hidePrimaryMeta()},hidePrimaryMeta:function(){for(var t=this.primaryMeta,i=0,e=t.length;i<e;i++)this.$editableCollection.find("[name$="+t[i]+"]").not('[type="hidden"]').closest(".qor-form-section").hide()},syncCollectionToVariant:function(i){var e=t(i.target),a=e.val(),n=e.prop("name").match(/\.\w+/g),r=void 0,o=void 0;n=n[n.length-1].replace(".",""),r=this.$editableVariant.find('[data-variant-type="'+n+'"]'),e.is("textarea")?(o=JSON.parse(a)[0].Url,r.html('<img src="'+o+'"/>')):r.html(a)},saveCollevtionEdit:function(i){var e=t(i.target),a=e.closest(m),n=a.closest("tr"),r=this.$element.find(".qor-product__container>.qor-field__block");n.remove(),a.appendTo(r).off(d,D,this.syncCollectionToVariant.bind(this)).off(l,M,this.saveCollevtionEdit.bind(this)).off(c,V,this.syncCollectionToVariant.bind(this)).hide()},selectVariants:function(i){var e=t(i.target).closest(p).data("variant-type"),a=i.params.data,n=a.selected,r=a.text||a.title||a.Name,o=e+"s",s={};return!this.ingoreInitChange&&(this.variants=this.PrimaryInitMetaData,this.variants[o]=this.variants[o]||[],n?(s[e]=r,s.id=a.id,this.variants[o].push(s)):(s=this.variants[o].filter(function(t){return t[e]!=r}),this.variants[o]=s),void this.renderVariants())},renderVariants:function(){var t=this.variants,i=[];return i=Object.keys(t).filter(function(i){return t[i].length>0}),0===i.length?void this.$tbody.html(""):(this.variantsKey=i,void this.convertVariantsData())},convertVariantsData:function(){var t=this.variants,i=[],a=this.variantsKey;if(e.each(a,function(e){i.push(t[e].length)}),this.lastTemplateData=this.templateData,this.templateData=[],1===a.length)for(var n=t[a[0]],r=0,o=n.length;r<o;r++){var s=n[r],l=e.keys(s)[0],d=s[l],c={};c[l]=d,c.id=s.id,c.variantID=""+g+d.replace(/\s/g,""),this.templateData.push(c)}else this.handleMultipleVariantsData(i,this.generateData.bind(this));this.renderVariantsTable()},renderVariantsTable:function(){var t=this.$tbody,i=this.template,e=this.templateData;t.html("");for(var a=0,n=e.length;a<n;a++){var r={};r=e[a],r.index=(Math.random()+1).toString(36).substring(7),t.append(window.Mustache.render(i,r))}t.trigger("enable"),this.doReplicator()},doReplicator:function(){var i=this,a=this.templateData,n=this.lastTemplateData,o=void 0,s=[];this.$element.find(q).addClass(b);for(var l=function(i,r){var l=a[i];if(o=e.filter(n,function(t){return e.isEqual(t,l)}),o.length){var d=t("#"+o[0].variantID);d.length&&d.removeClass(b)}else s.push(l)},d=0,c=a.length;d<c;d++)l(d,c);this.replicator=this.replicator||this.$element.find(v).data(r),setTimeout(function(){i.replicator.addReplicators(s,i.$replicatorBtn)},500),this.$element.find(q+"."+b).find(".qor-fieldset__delete").trigger("click")},generateData:function(t){for(var i=this.variantsKey,a=this.variants,n=void 0,r={},o=0,s=t.length;o<s;o++){var l=a[i[o]][t[o]];r[i[o]+"_ID"]=l.id,r=Object.assign({},r,l)}delete r.id,n=e.values(r).map(this.removeSpace),r.variantID=""+g+n.join("_"),this.templateData.push(r)},handleMultipleVariantsData:function(t,i){this.convertMultipleVariantsData(t,i,[],0)},convertMultipleVariantsData:function(t,i,e,a){if(0==t.length)i(e);else{var n=t.slice(1);for(e[a]=0;e[a]<t[0];++e[a])this.convertMultipleVariantsData(n,i,e,a+1)}},addVariantReplicator:function(t,i,e){i.attr({"variant-data":JSON.stringify(e),id:e.variantID}).hide(),this.syncReplicatorData(i,e)},syncReplicatorData:function(t,i){for(var e=Object.keys(i),a=0,n=e.length;a<n;a++){var r=t.find("[name$="+e[a]+"]").not('[type="hidden"]'),o=void 0;r.length&&r.is("select")&&r.data("remote-data")&&(o=e[a]+"s_ID",r.append("<option selected value='"+(i.id||i[o])+"'>"+i[e[a]]+"</option>").trigger("change"))}},destroy:function(){this.unbind(),this.$element.removeData(n)}},i.plugin=function(e){return this.each(function(){var a=t(this),r=a.data(n),o=void 0;if(!r){if(/destroy/.test(e))return;a.data(n,r=new i(this,e))}"string"==typeof e&&t.isFunction(o=r[e])&&o.apply(r)})},t(function(){var e='[data-toggle="qor.product.variants"]';t(document).on(s,function(a){i.plugin.call(t(e,a.target),"destroy")}).on(o,function(a){i.plugin.call(t(e,a.target))}).triggerHandler(o)}),i});