"use strict";var _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t};!function(t){"function"==typeof define&&define.amd?define(["jquery"],t):t("object"===("undefined"==typeof exports?"undefined":_typeof(exports))?require("jquery"):jQuery)}(function(t){function e(i,a){this.$element=t(i),this.options=t.extend({},e.DEFAULTS,t.isPlainObject(a)&&a),this.init()}var i=window._,a=t(document),n="qor.product.variants",r="enable."+n,s="disable."+n,o="qor.replicator",l="added.qor.replicator",d='.qor-product__property select[data-toggle="qor.chooser"]',h=".qor-product__property-selector",c=".qor-product__table tbody",p=".qor-product__container",u=".qor-fieldset__add",f="qor_variants_id_",v="should_remove",m=".qor-fieldset--init",y=".qor-fieldset:not(.qor-fieldset--new)";return e.prototype={constructor:e,init:function(){var t=this.$element;this.bind(),this.variants={},this.PrimaryInitMetaData={},this.productMetas=[],this.templateData=[],this.$tbody=t.find(c),this.$replicatorBtn=t.find(u),this.initMetas(),this.initPrimaryMeta()},bind:function(){a.on(l,this.addVariantReplicator.bind(this)),this.$element.on("select2:select select2:unselect",d,this.selectVariants.bind(this))},unbind:function(){},initMetas:function(){for(var e=this.$element.find("td.qor-product__meta"),i=0,a=e.length;i<a;i++)this.productMetas.push(t(e[i]).data("inputName"));this.setTemplate()},initPrimaryMeta:function(){for(var e=this.$element.find(h),i=this.$element.find(m),a=void 0,n=[],r={},s=0,o=e.length;s<o;s++){a=t(e[s]).data("variant-type");for(var l=0,d=i.length;l<d;l++){var c=t(i[l]),p=c.find("[name$="+a+"]").not('[type="hidden"]'),u={};p.is("select")&&(p.val()?(u[a]=p.find("option").text(),u.id=p.val(),n.push(u)):n=[])}n.length&&(r[a+"s"]=n)}this.PrimaryInitMetaData=r,this.initPrimarySelector()},initPrimarySelector:function(){var e=this.PrimaryInitMetaData,i=Object.keys(e);this.ingoreInitChange=!0;for(var a=0,n=i.length;a<n;a++){for(var r=i[a].slice(0,-1),s=t('[data-variant-type="'+r+'"]').find(".qor-field__input-selector"),o=e[i[a]],l=0,d=o.length;l<d;l++)s.append("<option selected value='"+o[l].id+"'>"+o[l][r]+"</option>");s.trigger("change")}this.ingoreInitChange=!1},removeSpace:function(t){return t.toString().replace(/\s/g,"")},setTemplate:function(){var t=this.productMetas,e="<tr>";i.each(t,function(t){e=e+"<td>[["+t+"]]</td>"}.bind(this)),this.template=e+"</tr>"},selectVariants:function(e){var i=t(e.target).closest(h).data("variant-type"),a=e.params.data,n=a.selected,r=a.text||a.title||a.Name,s=i+"s",o={};return!this.ingoreInitChange&&(this.variants=this.PrimaryInitMetaData,this.variants[s]=this.variants[s]||[],n?(o[i]=r,o.id=a.id,this.variants[s].push(o)):(o=this.variants[s].filter(function(t){return t[i]!=r}),this.variants[s]=o),void this.renderVariants())},renderVariants:function(){var t=this.variants,e=[];return e=Object.keys(t).filter(function(e){return t[e].length>0}),0===e.length?void this.$tbody.html(""):(this.variantsKey=e,void this.convertVariantsData())},convertVariantsData:function(){var t=this.variants,e=[],a=this.variantsKey;if(i.each(a,function(i){e.push(t[i].length)}),this.lastTemplateData=this.templateData,this.templateData=[],1===a.length)for(var n=t[a[0]],r=0,s=n.length;r<s;r++){var o=n[r],l=i.keys(o)[0],d=o[l],h={};h[l]=d,h.id=o.id,h.variantID=""+f+d.replace(/\s/g,""),this.templateData.push(h)}else this.handleMultipleVariantsData(e,this.generateData.bind(this));this.renderVariantsTable()},renderVariantsTable:function(){var t=this.$tbody,e=this.template,i=this.templateData;t.html("");for(var a=0,n=i.length;a<n;a++)t.append(window.Mustache.render(e,i[a]));this.doReplicator()},doReplicator:function(){var e=this,a=this.templateData,n=this.lastTemplateData,r=void 0,s=[];this.$element.find(y).addClass(v);for(var l=function(e,o){var l=a[e];if(r=i.filter(n,function(t){return i.isEqual(t,l)}),r.length){var d=t("#"+r[0].variantID);d.length&&d.removeClass(v)}else s.push(l)},d=0,h=a.length;d<h;d++)l(d,h);this.replicator=this.replicator||this.$element.find(p).data(o),setTimeout(function(){e.replicator.addReplicators(s,e.$replicatorBtn)},500),this.$element.find(y+"."+v).find(".qor-fieldset__delete").trigger("click")},generateData:function(t){for(var e=this.variantsKey,a=this.variants,n=void 0,r={},s=0,o=t.length;s<o;s++){var l=a[e[s]][t[s]];r[e[s]+"_ID"]=l.id,r=Object.assign({},r,l)}delete r.id,n=i.values(r).map(this.removeSpace),r.variantID=""+f+n.join("_"),this.templateData.push(r)},handleMultipleVariantsData:function(t,e){this.convertMultipleVariantsData(t,e,[],0)},convertMultipleVariantsData:function(t,e,i,a){if(0==t.length)e(i);else{var n=t.slice(1);for(i[a]=0;i[a]<t[0];++i[a])this.convertMultipleVariantsData(n,e,i,a+1)}},addVariantReplicator:function(t,e,i){e.attr({"variant-data":JSON.stringify(i),id:i.variantID}).hide(),this.syncReplicatorData(e,i)},syncReplicatorData:function(t,e){for(var i=Object.keys(e),a=0,n=i.length;a<n;a++){var r=t.find("[name$="+i[a]+"]").not('[type="hidden"]'),s=void 0;r.length&&r.is("select")&&r.data("remote-data")&&(s=i[a]+"s_ID",r.append("<option selected value='"+(e.id||e[s])+"'>"+e[i[a]]+"</option>").trigger("change"))}},destroy:function(){this.unbind(),this.$element.removeData(n)}},e.plugin=function(i){return this.each(function(){var a=t(this),r=a.data(n),s=void 0;if(!r){if(/destroy/.test(i))return;a.data(n,r=new e(this,i))}"string"==typeof i&&t.isFunction(s=r[i])&&s.apply(r)})},t(function(){var i='[data-toggle="qor.product.variants"]';t(document).on(s,function(a){e.plugin.call(t(i,a.target),"destroy")}).on(r,function(a){e.plugin.call(t(i,a.target))}).triggerHandler(r)}),e});