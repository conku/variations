"use strict";var _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t};!function(t){"function"==typeof define&&define.amd?define(["jquery"],t):t("object"===("undefined"==typeof exports?"undefined":_typeof(exports))?require("jquery"):jQuery)}(function(t){function i(e,a){this.$element=t(e),this.options=t.extend({},i.DEFAULTS,t.isPlainObject(a)&&a),this.init()}var e=window._,a=t(document),n="qor.product.variants",r="qor.replicator",o="enable."+n,s="disable."+n,d="click."+n,l="keyup."+n,c="changed.medialibrary",h="added."+r,v="addedMultiple."+r,u=".qor-product__property",p='.qor-product__property select[data-toggle="qor.chooser"]',f=".qor-product__property-selector",m=".qor-product__table tbody",g=".qor-product__table tbody tr",y=".qor-product__container",b=".qor-fieldset",_=".qor-fieldset__add",D="qor_variants_id_",q="should_remove",V="is_removed",I="is_current",j=".qor-fieldset--init",M=".qor-fieldset:not(.qor-fieldset--new)",T='input[name*="QorResource.Variations"]:visible',$=".qor-field__mediabox-data",C=".qor-product__button-save";return i.prototype={constructor:i,init:function(){var t=this.$element;this.bind(),this.variants={},this.PrimaryInitMetaData={},this.productMetas=[],this.templateData=[],this.primaryMeta=[],this.existVariantsID=[],this.$tbody=t.find(m),this.$replicatorBtn=t.find(_),this.$fieldBlock=t.find(".qor-product__container>.qor-field__block"),this.initMetas(),this.initPrimaryMeta()},bind:function(){a.on(h,this.addVariantReplicator.bind(this)).on(v,this.addVariantReplicators.bind(this)),this.$element.on("select2:select select2:unselect",p,this.selectVariants.bind(this)).on(d,".qor-product__action--edit",this.editVariant.bind(this))},unbind:function(){},initMetas:function(){for(var i=this.$element.find(".qor-product__meta"),e=0,a=i.length;a>e;e++)this.productMetas.push(t(i[e]).data("inputName"));this.setTemplate()},collectExistVariantsID:function(){for(var i=this.$tbody.find("tr:not(."+V+")"),e=0,a=i.length;a>e;e++)this.existVariantsID.push(t(i[e]).attr("variants-id"))},initPrimaryMeta:function(){var i=this.$element.find(f),e=this.$element.find(j),a={},n=[],r=void 0;if(e.length){for(var o=0,s=i.length;s>o;o++){var d=[],l=t(i[o]).data("variant-type");this.primaryMeta.push(l);for(var c=0,h=e.length;h>c;c++){var v=t(e[c]),u=v.find("[name$="+l+"]").not('[type="hidden"]'),p={},m={};u.is("select")&&u.val()&&(p[l]=u.find("option").html(),p.id=u.val(),r=this.checkSameObj(n,p),r||d.push(p),m[l+"_ID"]=p.id,m[l]=p[l],v.data("variants-"+l,m)),n.push(p)}d.length&&(a[l+"s"]=d)}this.variants=this.PrimaryInitMetaData=a,this.variantsKey=this.collectObjectKeys(),this.handleTemplateData(),this.initPrimarySelector(),this.setCollectionID(e)}},initPrimarySelector:function(){var i=this.PrimaryInitMetaData,e=Object.keys(i);this.ingoreInitChange=!0;for(var a=0,n=e.length;n>a;a++){for(var r=e[a].slice(0,-1),o=t('[data-variant-type="'+r+'"]').find(".qor-field__input-selector"),s=i[e[a]],d=0,l=s.length;l>d;d++)o.append("<option selected value='"+s[d].id+"'>"+s[d][r]+"</option>");o.trigger("change")}this.ingoreInitChange=!1},setCollectionID:function(i){for(var a=this.primaryMeta,n=[],r=0,o=i.length;o>r;r++){for(var s=t(i[r]),d={},l=void 0,c=void 0,h=0,v=a.length;v>h;h++){var u=s.data("variants-"+a[h]);u&&(d=Object.assign({},d,u))}l=e.values(d).map(this.removeSpace).sort(),c=""+D+l.join("_"),d.variantID=c,s.attr("id",c),n.push(d)}this.setTableID(n)},setTableID:function(i){for(var a=this.primaryMeta,n=this.$element.find(g),r=void 0,o=0,s=n.length;s>o;o++){for(var d={},l=t(n[o]),c=0,h=a.length;h>c;c++){var v=a[c],u={},p=l.find('[data-variant-type="'+v+'"]').text();p&&(u[v]=p,d=Object.assign({},d,u))}r=e.where(i,d),r.length&&l.attr("variants-id",r[0].variantID)}},removeSpace:function(t){return t.toString().replace(/\s/g,"")},checkSameObj:function(t,i){var a=void 0;return a=t.some(function(t){return e.isEqual(t,i)})},collectObjectKeys:function(t){var i=[],e=t||this.variants;return i=Object.keys(e).filter(function(t){return e[t].length>0})},setTemplate:function(){var t=this.productMetas,i="<tr variants-id=[[variantID]]>",a='<td>\n                                <button type="button" id="qor-product-actions-for-[[variantID]]" class="mdl-button mdl-js-button mdl-button--icon qor-product__action">\n                                    <i class="material-icons">more_vert</i>\n                                </button>\n                                <ul class="mdl-menu mdl-menu--bottom-right mdl-js-menu" for="qor-product-actions-for-[[variantID]]">\n                                    <li class="mdl-menu__item" qor-icon-name="Edit">\n                                        <a href="javascript://" class="qor-product__action--edit">Edit</a>\n                                    </li>\n                                </ul>\n                            </td></tr>';e.each(t,function(t){i=i+"<td data-variant-type="+t+' class="mdl-data-table__cell--non-numeric">[['+t+"]]</td>"}),this.template=""+i+a},editVariant:function(i){var e=t(i.target).closest("tr"),a=e.find("td").length,n=e.attr("variants-id"),r=void 0,o=t('<tr class="qor-variant__edit"><td class="normal" colspan='+a+"></td></tr>"),s='<button type="button" class="mdl-button mdl-js-button mdl-button--raised '+C.replace(".","")+'">OK</button>';return e.next("tr.qor-variant__edit").length?!1:n?(r=t("#"+n),e.addClass(I).after(o),r.appendTo(o.find("td")).find(C).remove().end().append(s).show().removeClass("hidden").on(l,T,this.syncCollectionToVariant.bind(this)).on(d,C,this.saveCollevtionEdit.bind(this)).on(c,$,this.syncCollectionToVariant.bind(this)),void this.hidePrimaryMeta(r)):!1},hidePrimaryMeta:function(t){for(var i=this.primaryMeta,e=0,a=i.length;a>e;e++)t.find("[name$="+i[e]+"]").not('[type="hidden"]').closest(".qor-form-section").hide()},syncCollectionToVariant:function(i){var e=t(i.target),a=e.val(),n=e.closest(b).attr("id"),r=t('tr[variants-id="'+n+'"]'),o=e.prop("name").match(/\.\w+/g),s=void 0,d=void 0;o=o[o.length-1].replace(".",""),s=r.find('[data-variant-type="'+o+'"]'),e.is("textarea")?(d=JSON.parse(a)[0].Url,s.html('<img src="'+d+'"/>')):s.html(a)},saveCollevtionEdit:function(i){var e=t(i.target),a=e.closest(b),n=a.closest("tr");n.prev().removeClass(I).end().remove(),a.appendTo(this.$fieldBlock).off(l,T,this.syncCollectionToVariant.bind(this)).off(d,C,this.saveCollevtionEdit.bind(this)).off(c,$,this.syncCollectionToVariant.bind(this)).hide()},selectVariants:function(i){var e=t(i.target).closest(f).data("variant-type"),a=i.params.data,n=a.selected,r=a.text||a.title||a.Name,o=e+"s",s={};return this.ingoreInitChange?!1:(this.variants[o]=this.variants[o]||[],void(n?(s[e]=r,s.id=a.id.toString(),this.variants[o].push(s),this.renderVariants()):(s=this.variants[o].filter(function(t){return t[e]!=r}),this.variants[o]=s,this.removeVariants(r,a.id,e),this.handleTemplateData())))},removeVariants:function(t,i,a){var n=this.templateData,r={};r[a]=t,r[a+"s_ID"]=i,this.hiddenVariantsID=[];for(var o=0,s=n.length;s>o;o++){var d=n[o],l=void 0;e.isMatch(d,r)&&(l=d.variantID,this.hideRemovedVariants(l),this.hiddenVariantsID.push(l))}},hideRemovedVariants:function(t){var i=this.$tbody.find('tr[variants-id="'+t+'"]'),e=this.$element.find("fieldset#"+t);i.hide().addClass(V),e.find(".qor-fieldset__delete").trigger("click").hide().addClass(V)},renderVariants:function(){var t=void 0;return t=this.collectObjectKeys(),0===t.length?void this.$tbody.html(""):(this.variantsKey=t,void this.convertVariantsData())},convertVariantsData:function(){this.handleTemplateData(),this.renderVariantsTable()},handleTemplateData:function(){var t=[],i=this.variantsKey,a=this.variants;if(this.templateData=[],e.each(i,function(i){t.push(a[i].length)}),1===i.length)for(var n=a[i[0]],r=0,o=n.length;o>r;r++){var s=n[r],d=e.keys(s)[0],l=s[d],c=void 0,h={};h[d]=l,h.id=s.id,c=e.values(h).map(this.removeSpace).sort(),h.variantID=""+D+c.join("_"),this.templateData.push(h)}else this.handleMultipleVariantsData(t,this.generateData.bind(this))},renderVariantsTable:function(){var t=this.$tbody,i=this.checkTemplateData().newObjs;this.$element.find(g+"."+q).hide(),i.length&&(t.trigger("enable"),this.doReplicator(i))},doReplicator:function(t){var i=this,e=this.$element;this.replicator=this.replicator||e.find(y).data(r),setTimeout(function(){i.replicator.addReplicators(t,i.$replicatorBtn)},500),this.$element.find("."+q+M).find(".qor-fieldset__delete").trigger("click").hide()},checkTemplateData:function(){var i=this.templateData,a=this.hiddenVariantsID||[],n=[],r=[];this.collectExistVariantsID(),this.$element.find(M).addClass(q).end().find(g).addClass(q);for(var o=0,s=i.length;s>o;o++){var d=i[o],l=void 0,c=void 0,h=d.variantID;if(a.length&&(l=e.contains(a,h)),this.existVariantsID.length&&(c=e.contains(this.existVariantsID,h)),l||c){r.push(d);var v=t("#"+h),u=t('tr[variants-id="'+h+'"]');v.removeClass(q+" "+V).find(".qor-fieldset__alert").remove(),u.removeClass(q+" "+V).show()}else this.$tbody.append(window.Mustache.render(this.template,d)),n.push(d)}return{oldObjs:r,newObjs:n}},generateData:function(t){for(var i=this.variantsKey,a=this.variants,n=void 0,r={},o=0,s=t.length;s>o;o++){var d=a[i[o]][t[o]];r[i[o]+"_ID"]=d.id,r=Object.assign({},r,d)}delete r.id,n=e.values(r).map(this.removeSpace).sort(),r.variantID=""+D+n.join("_"),this.templateData.push(r)},handleMultipleVariantsData:function(t,i){this.convertMultipleVariantsData(t,i,[],0)},convertMultipleVariantsData:function(t,i,e,a){if(0==t.length)i(e);else{var n=t.slice(1);for(e[a]=0;e[a]<t[0];++e[a])this.convertMultipleVariantsData(n,i,e,a+1)}},addLoading:function(){t(".qor-product__loading").remove();var e=t(i.TEMPLATE_LOADING);e.appendTo(t(u)).trigger("enable")},addVariantReplicator:function(t,i,e){i.closest(".qor-product__container").length&&(i.attr({"variant-data":JSON.stringify(e),id:e.variantID}).hide(),this.syncReplicatorData(i,e))},addVariantReplicators:function(){t(".qor-product__loading").remove()},syncReplicatorData:function(t,i){for(var e=Object.keys(i),a=0,n=e.length;n>a;a++){var r=t.find("[name$="+e[a]+"]").not('[type="hidden"]'),o=void 0;r.length&&r.is("select")&&r.data("remote-data")&&(o=e[a]+"s_ID",r.append("<option selected value='"+(i.id||i[o])+"'>"+i[e[a]]+"</option>").trigger("change"))}},destroy:function(){this.unbind(),this.$element.removeData(n)}},i.TEMPLATE_LOADING='<div class="qor-product__loading">\n            <div><div class="mdl-spinner mdl-js-spinner is-active qor-layout__bottomsheet-spinner"></div></div>\n        </div>',i.plugin=function(e){return this.each(function(){var a=t(this),r=a.data(n),o=void 0;if(!r){if(/destroy/.test(e))return;a.data(n,r=new i(this,e))}"string"==typeof e&&t.isFunction(o=r[e])&&o.apply(r)})},t(function(){var e='[data-toggle="qor.product.variants"]';t(document).on(s,function(a){i.plugin.call(t(e,a.target),"destroy")}).on(o,function(a){i.plugin.call(t(e,a.target))}).triggerHandler(o)}),i});