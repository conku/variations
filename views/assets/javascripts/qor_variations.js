"use strict";var _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t};!function(t){"function"==typeof define&&define.amd?define(["jquery"],t):t("object"===("undefined"==typeof exports?"undefined":_typeof(exports))?require("jquery"):jQuery)}(function(t){function e(i,a){this.$element=t(i),this.options=t.extend({},e.DEFAULTS,t.isPlainObject(a)&&a),this.init()}var i=window._,a=t(document),n="qor.product.variants",r="qor.replicator",o="enable."+n,s="disable."+n,l="click."+n,d="keyup."+n,c="changed.medialibrary",h="added."+r,u="addedMultiple."+r,p=".qor-product__property",v='.qor-product__property select[data-toggle="qor.chooser"]',f=".qor-product__property-selector",m=".qor-product__table tbody",g=".qor-product__table tbody tr",y=".qor-product__container",b=".qor-fieldset",_=".qor-fieldset__add",D="qor_variants_id_",q="should_remove",T=".qor-fieldset--init",M=".qor-fieldset:not(.qor-fieldset--new)",I='input[name*="QorResource.Variations"]:visible',V=".qor-field__mediabox-data",j=".qor-product__button-save";return e.prototype={constructor:e,init:function(){var t=this.$element;this.bind(),this.variants={},this.PrimaryInitMetaData={},this.productMetas=[],this.templateData=[],this.primaryMeta=[],this.$tbody=t.find(m),this.$replicatorBtn=t.find(_),this.$fieldBlock=t.find(".qor-product__container>.qor-field__block"),this.initMetas(),this.initPrimaryMeta()},bind:function(){a.on(h,this.addVariantReplicator.bind(this)).on(u,this.addVariantReplicators.bind(this)),this.$element.on("select2:select select2:unselect",v,this.selectVariants.bind(this)).on(l,".qor-product__action--edit",this.editVariant.bind(this))},unbind:function(){},initMetas:function(){for(var e=this.$element.find(".qor-product__meta"),i=0,a=e.length;i<a;i++)this.productMetas.push(t(e[i]).data("inputName"));this.setTemplate()},initPrimaryMeta:function(){var e=this.$element.find(f),i=this.$element.find(T),a={},n=[],r=void 0;if(i.length){for(var o=0,s=e.length;o<s;o++){var l=[],d=t(e[o]).data("variant-type");this.primaryMeta.push(d);for(var c=0,h=i.length;c<h;c++){var u=t(i[c]),p=u.find("[name$="+d+"]").not('[type="hidden"]'),v={},m={};p.is("select")&&p.val()&&(v[d]=p.find("option").html(),v.id=p.val(),r=this.checkSameObj(n,v),r||l.push(v),m[d+"_ID"]=v.id,m[d]=v[d],u.data("variants-"+d,m)),n.push(v)}l.length&&(a[d+"s"]=l)}this.variants=this.PrimaryInitMetaData=a,this.variantsKey=this.collectObjectKeys(),this.handleTemplateData(),this.initPrimarySelector(),this.setCollectionID(i)}},initPrimarySelector:function(){var e=this.PrimaryInitMetaData,i=Object.keys(e);this.ingoreInitChange=!0;for(var a=0,n=i.length;a<n;a++){for(var r=i[a].slice(0,-1),o=t('[data-variant-type="'+r+'"]').find(".qor-field__input-selector"),s=e[i[a]],l=0,d=s.length;l<d;l++)o.append("<option selected value='"+s[l].id+"'>"+s[l][r]+"</option>");o.trigger("change")}this.ingoreInitChange=!1},setCollectionID:function(e){for(var a=this.primaryMeta,n=[],r=0,o=e.length;r<o;r++){for(var s=t(e[r]),l={},d=void 0,c=void 0,h=0,u=a.length;h<u;h++){var p=s.data("variants-"+a[h]);p&&(l=Object.assign({},l,p))}d=i.values(l).map(this.removeSpace),c=""+D+d.join("_"),l.variantID=c,s.attr("id",c),n.push(l)}this.setTableID(n)},setTableID:function(e){for(var a=this.primaryMeta,n=this.$element.find(g),r=void 0,o=0,s=n.length;o<s;o++){for(var l={},d=t(n[o]),c=0,h=a.length;c<h;c++){var u=a[c],p={},v=d.find('[data-variant-type="'+u+'"]').text();v&&(p[u]=v,l=Object.assign({},l,p))}r=i.where(e,l),r.length&&d.attr("variants-id",r[0].variantID)}},removeSpace:function(t){return t.toString().replace(/\s/g,"")},checkSameObj:function(t,e){var a=void 0;return a=t.some(function(t){return i.isEqual(t,e)})},collectObjectKeys:function(t){var e=[],i=t||this.variants;return e=Object.keys(i).filter(function(t){return i[t].length>0})},setTemplate:function(){var t=this.productMetas,e="<tr variants-id=[[variantID]]>",a='<td class="mdl-data-table__cell--non-numeric">\n                                <button type="button" id="qor-product-actions-for-[[variantID]]" class="mdl-button mdl-js-button mdl-button--icon qor-product__action">\n                                    <i class="material-icons">more_vert</i>\n                                </button>\n                                <ul class="mdl-menu mdl-menu--bottom-right mdl-js-menu" for="qor-product-actions-for-[[variantID]]">\n                                    <li class="mdl-menu__item" qor-icon-name="Edit">\n                                        <a href="javascript://" class="qor-product__action--edit">Edit</a>\n                                    </li>\n                                </ul>\n                            </td></tr>';i.each(t,function(t){e=e+"<td data-variant-type="+t+">[["+t+"]]</td>"}),this.template=""+e+a},editVariant:function(e){var i=t(e.target).closest("tr"),a=i.find("td").length,n=i.attr("variants-id"),r=void 0,o=t('<tr class="qor-variant__edit"><td class="normal" colspan='+a+"></td></tr>"),s='<button type="button" class="mdl-button mdl-js-button mdl-button--raised '+j.replace(".","")+'">OK</button>';return!i.next("tr.qor-variant__edit").length&&(!!n&&(r=t("#"+n),i.after(o),r.appendTo(o.find("td")).find(j).remove().end().append(s).show().removeClass("hidden").on(d,I,this.syncCollectionToVariant.bind(this)).on(l,j,this.saveCollevtionEdit.bind(this)).on(c,V,this.syncCollectionToVariant.bind(this)),void this.hidePrimaryMeta(r)))},hidePrimaryMeta:function(t){for(var e=this.primaryMeta,i=0,a=e.length;i<a;i++)t.find("[name$="+e[i]+"]").not('[type="hidden"]').closest(".qor-form-section").hide()},syncCollectionToVariant:function(e){var i=t(e.target),a=i.val(),n=i.closest(b).attr("id"),r=t('tr[variants-id="'+n+'"]'),o=i.prop("name").match(/\.\w+/g),s=void 0,l=void 0;o=o[o.length-1].replace(".",""),s=r.find('[data-variant-type="'+o+'"]'),i.is("textarea")?(l=JSON.parse(a)[0].Url,s.html('<img src="'+l+'"/>')):s.html(a)},saveCollevtionEdit:function(e){var i=t(e.target),a=i.closest(b),n=a.closest("tr");n.remove(),a.appendTo(this.$fieldBlock).off(d,I,this.syncCollectionToVariant.bind(this)).off(l,j,this.saveCollevtionEdit.bind(this)).off(c,V,this.syncCollectionToVariant.bind(this)).hide()},selectVariants:function(e){var i=t(e.target).closest(f).data("variant-type"),a=e.params.data,n=a.selected,r=a.text||a.title||a.Name,o=i+"s",s={};return!this.ingoreInitChange&&(this.variants[o]=this.variants[o]||[],n?(s[i]=r,s.id=a.id.toString(),this.variants[o].push(s)):(s=this.variants[o].filter(function(t){return t[i]!=r}),this.variants[o]=s),void this.renderVariants())},renderVariants:function(){var t=void 0;return t=this.collectObjectKeys(),0===t.length?void this.$tbody.html(""):(this.variantsKey=t,void this.convertVariantsData())},convertVariantsData:function(){this.lastTemplateData=this.templateData,this.handleTemplateData(),this.renderVariantsTable()},handleTemplateData:function(){var t=[],e=this.variantsKey,a=this.variants;if(this.templateData=[],i.each(e,function(e){t.push(a[e].length)}),1===e.length)for(var n=a[e[0]],r=0,o=n.length;r<o;r++){var s=n[r],l=i.keys(s)[0],d=s[l],c={};c[l]=d,c.id=s.id,c.variantID=""+D+d.replace(/\s/g,""),this.templateData.push(c)}else this.handleMultipleVariantsData(t,this.generateData.bind(this))},renderVariantsTable:function(){var t=this.$tbody,e=this.template,i=this.checkTemplateData(),a=t.find(".qor-variant__edit");a.length&&a.find(b).appendTo(this.$fieldBlock);for(var n=0,r=i.length;n<r;n++){var o={};o=i[n],t.append(window.Mustache.render(e,o))}this.$element.find(g+"."+q).remove(),t.trigger("enable"),this.doReplicator()},doReplicator:function(){var t=this,e=this.checkTemplateData();this.replicator=this.replicator||this.$element.find(y).data(r),setTimeout(function(){t.replicator.addReplicators(e,t.$replicatorBtn)},500),this.$element.find(M+"."+q).find(".qor-fieldset__delete").trigger("click").hide()},checkTemplateData:function(){var e=this.templateData,a=this.lastTemplateData,n=[];this.$element.find(M).addClass(q).find(g).addClass(q);for(var r=function(r,o){var s=e[r],l=[];if(a.length&&(l=i.filter(a,function(t){return i.isEqual(t,s)})),l.length){var d=t("#"+l[0].variantID),c=t('tr[variants-id="'+l[0].variantID+'"]');d.length&&d.removeClass(q),c.length&&c.removeClass(q)}else n.push(s)},o=0,s=e.length;o<s;o++)r(o,s);return n},generateData:function(t){for(var e=this.variantsKey,a=this.variants,n=void 0,r={},o=0,s=t.length;o<s;o++){var l=a[e[o]][t[o]];r[e[o]+"_ID"]=l.id,r=Object.assign({},r,l)}delete r.id,n=i.values(r).map(this.removeSpace),r.variantID=""+D+n.join("_"),this.templateData.push(r)},handleMultipleVariantsData:function(t,e){this.convertMultipleVariantsData(t,e,[],0)},convertMultipleVariantsData:function(t,e,i,a){if(0==t.length)e(i);else{var n=t.slice(1);for(i[a]=0;i[a]<t[0];++i[a])this.convertMultipleVariantsData(n,e,i,a+1)}},addLoading:function(){t(".qor-product__loading").remove();var i=t(e.TEMPLATE_LOADING);i.appendTo(t(p)).trigger("enable")},addVariantReplicator:function(t,e,i){e.attr({"variant-data":JSON.stringify(i),id:i.variantID}).hide(),this.syncReplicatorData(e,i)},addVariantReplicators:function(){t(".qor-product__loading").remove()},syncReplicatorData:function(t,e){for(var i=Object.keys(e),a=0,n=i.length;a<n;a++){var r=t.find("[name$="+i[a]+"]").not('[type="hidden"]'),o=void 0;r.length&&r.is("select")&&r.data("remote-data")&&(o=i[a]+"s_ID",r.append("<option selected value='"+(e.id||e[o])+"'>"+e[i[a]]+"</option>").trigger("change"))}},destroy:function(){this.unbind(),this.$element.removeData(n)}},e.TEMPLATE_LOADING='<div class="qor-product__loading">\n            <div><div class="mdl-spinner mdl-js-spinner is-active qor-layout__bottomsheet-spinner"></div></div>\n        </div>',e.plugin=function(i){return this.each(function(){var a=t(this),r=a.data(n),o=void 0;if(!r){if(/destroy/.test(i))return;a.data(n,r=new e(this,i))}"string"==typeof i&&t.isFunction(o=r[i])&&o.apply(r)})},t(function(){var i='[data-toggle="qor.product.variants"]';t(document).on(s,function(a){e.plugin.call(t(i,a.target),"destroy")}).on(o,function(a){e.plugin.call(t(i,a.target))}).triggerHandler(o)}),e});