{{$current_values := (raw_value_of .ResourceValue .Meta)}}
{{$meta := .Meta}}
{{$inputName := .InputName}}

<div class="qor-field" data-toggle="qor.product.variants" {{if $current_values}}data-input-value-length="{{len $current_values}}" {{end}}>
  <label class="qor-field__label" for="{{.InputId}}">
    {{meta_label .Meta}}
  </label>

  <div class="qor-product__property">
    {{range $primaryMeta := $meta.Config.PrimaryAttributeMetas}}
      <!-- render meta based on meta type (like select one -> select many, string -> tags) -->
      {{render_meta $meta.Resource.NewStruct $primaryMeta "variations"}}
    {{end}}
  </div>


  <div class="qor-fieldset-container qor-product__container">
    <div class="qor-field__block">
      <div class="qor-product__table">
        <table class="mdl-data-table mdl-js-data-table mdl-shadow--2dp">
          <thead>
            {{range $meta := convert_sections_to_metas $meta.Resource (edit_sections $meta.Resource)}}
              <th class="qor-product__meta mdl-data-table__cell--non-numeric" data-input-name="{{$meta.Name}}">{{meta_label $meta}}</th>
            {{end}}
            <th></th>
          </thead>
          <tbody>
            {{if $current_values}}
              {{range $index, $value := $current_values}}
                <tr>
                  {{range $meta := convert_sections_to_metas $meta.Resource (edit_sections $meta.Resource)}}
                    <td class="mdl-data-table__cell--non-numeric" data-variant-type="{{$meta.Name}}" data-input-name="{{printf "%v[%v].%v" $inputName $index $meta.Name}}">{{formatted_value_of $value $meta}}</td>
                  {{end}}
                  <td>
                    <button type="button" id="qor-product-actions-for-{{$index}}" class="mdl-button mdl-js-button mdl-button--icon qor-product__action">
                      <i class="material-icons">more_vert</i>
                    </button>
                    <ul class="mdl-menu mdl-menu--bottom-right mdl-js-menu" for="qor-product-actions-for-{{$index}}">
                      <li class="mdl-menu__item" qor-icon-name="Edit">
                        <a href="javascript://" class="qor-product__action--edit">Edit</a>
                      </li>
                    </ul>
                  </td>
                </tr>
              {{end}}
            {{end}}
          </tbody>
        </table>
      </div>

      {{range $index, $value := $current_values }}
        <fieldset class="qor-fieldset qor-fieldset--init hidden">
          {{if has_delete_permission $meta}}
            <button class="mdl-button qor-button--muted mdl-button--icon mdl-js-button qor-fieldset__delete" type="button">
              <i class="material-icons md-18">delete</i>
            </button>
          {{end}}
          {{render_nested_form $value (edit_sections $meta.Resource) $index}}
        </fieldset>
      {{end}}

      {{if has_create_permission .Meta}}
        <fieldset class="qor-fieldset qor-fieldset--new">
          <button class="mdl-button qor-button--muted mdl-button--icon mdl-js-button qor-fieldset__delete" type="button">
            <i class="material-icons md-18">delete</i>
          </button>
          {{if $current_values}}
            {{render_nested_form $meta.Resource.NewStruct (new_sections $meta.Resource) (len $current_values)}}
          {{else}}
            {{render_nested_form $meta.Resource.NewStruct (new_sections $meta.Resource) 0}}
          {{end}}
        </fieldset>

        <button class="mdl-button mdl-button--primary mdl-js-button mdl-js-ripple-effect qor-fieldset__add hidden" type="button">
          {{t (printf "%v.attributes.add_%v" .BaseResource.ToParam (singular (meta_label .Meta))) (printf "Add %v" (singular (meta_label .Meta)))}}
        </button>
      {{end}}
    </div>
  </div>
</div>

{{javascript_tag "qor_variations"}}
{{stylesheet_tag "qor_variations"}}
